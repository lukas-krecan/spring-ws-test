<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at May 8, 2013 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Client test tutorial</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20130508" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                                      <a href="./" id="bannerLeft">
                Spring WS Test
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2013-05-08</span>
                  &nbsp;| <span id="projectVersion">Version: 0.23-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="http://static.springsource.org/spring-ws/sites/1.5/" class="externalLink" title="Spring WS">Spring WS</a>
              
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                <h5>Spring WS Test</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
            <strong>Client Test Tutorial</strong>
          </li>
                  <li class="none">
                          <a href="unit-test-support.html" title="Advanced Client Unit Tests">Advanced Client Unit Tests</a>
            </li>
                  <li class="none">
                          <a href="server-test-support.html" title="Server test support">Server test support</a>
            </li>
                  <li class="none">
                          <a href="func-test.html" title="Functional tests">Functional tests</a>
            </li>
                  <li class="none">
                          <a href="download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="reference.html" title="Reference">Reference</a>
            </li>
                  <li class="none">
                          <a href="naq.html" title="N.A.Q">N.A.Q</a>
            </li>
                  <li class="none">
                          <a href="sample.html" title="Sample app">Sample app</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                                            <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                        <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                   <a href="http://maven.apache.org/" title="Maven" class="poweredBy">
        <img class="poweredBy"  alt="Maven" src="http://maven.apache.org/images/logos/maven-feather.png"    />
      </a>
                       
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!--  --><!-- Copyright 2009-2010 the original author or authors. --><!--  --><!-- Licensed under the Apache License, Version 2.0 (the "License"); --><!-- you may not use this file except in compliance with the License. --><!-- You may obtain a copy of the License at --><!--  --><!-- http://www.apache.org/licenses/LICENSE-2.0 --><!--  --><!-- Unless required by applicable law or agreed to in writing, software --><!-- distributed under the License is distributed on an "AS IS" BASIS, --><!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. --><!-- See the License for the specific language governing permissions and --><!-- limitations under the License. --><!--  --><!--  --><!-- Copyright 2006 the original author or authors. --><!--  --><!-- Licensed under the Apache License, Version 2.0 (the "License"); --><!-- you may not use this file except in compliance with the License. --><!-- You may obtain a copy of the License at --><!--  --><!-- http://www.apache.org/licenses/LICENSE-2.0 --><!--  --><!-- Unless required by applicable law or agreed to in writing, software --><!-- distributed under the License is distributed on an "AS IS" BASIS, --><!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. --><!-- See the License for the specific language governing permissions and --><!-- limitations under the License. --><!--  --><div class="section"><h2>Client Test Tutorial<a name="Client_Test_Tutorial"></a></h2><p>This page provides a step-by-step tutorial of WS client testing. In the tutorial we will test a simple calculator web service. The source code of the sample application is downloadable <a class="externalLink" href="https://java-crumbs.svn.sourceforge.net/svnroot/java-crumbs/simple-client-test/tags/simple-client-test-0.22/simple-client-test/">from SVN repository</a>.</p><p>It's possible to download it using following command <tt>svn co https://java-crumbs.svn.sourceforge.net/svnroot/java-crumbs/simple-client-test/tags/simple-client-test-0.22/simple-client-test/ simple-client-test</tt></p><div class="section"><h3>Tested application <a name="Tested_application"></a></h3><p>Let's start with the XSD defining data structures of the service.</p><div><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;schema xmlns=&quot;http://www.w3.org/2001/XMLSchema&quot; targetNamespace=&quot;http://javacrumbs.net/calc&quot;
        xmlns:tns=&quot;http://javacrumbs.net/calc&quot; elementFormDefault=&quot;qualified&quot;&gt;

        &lt;element name=&quot;plusRequest&quot;&gt;
                &lt;complexType&gt;
                        &lt;sequence&gt;
                                &lt;element name=&quot;a&quot; type=&quot;int&quot; /&gt;
                                &lt;element name=&quot;b&quot; type=&quot;int&quot; /&gt;
                        &lt;/sequence&gt;
                &lt;/complexType&gt;
        &lt;/element&gt;

        &lt;element name=&quot;plusResponse&quot;&gt;
                &lt;complexType&gt;
                        &lt;sequence&gt;
                                &lt;element name=&quot;result&quot; type=&quot;int&quot; /&gt;
                        &lt;/sequence&gt;
                &lt;/complexType&gt;
        &lt;/element&gt;
&lt;/schema&gt;</pre></div><p>There is one &quot;operation&quot; called <tt>plus</tt> allowing to add two numbers. The result is returned in the <tt>result</tt> element. </p><p>Spring configuration (<a class="externalLink" href="https://java-crumbs.svn.sourceforge.net/svnroot/java-crumbs/simple-client-test/tags/simple-client-test-0.22/simple-client-test/src/main/resources/client-config.xml">client-config.xml</a>) is simple too.</p><div><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
        xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
        xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;
        
        &lt;bean class=&quot;net.javacrumbs.calc.Calc&quot;/&gt;
        
        &lt;bean id=&quot;wsTemplate&quot; class=&quot;org.springframework.ws.client.core.WebServiceTemplate&quot;&gt;
                &lt;property name=&quot;defaultUri&quot; value=&quot;http://localhost/calc&quot;/&gt;
                &lt;property name=&quot;marshaller&quot; ref=&quot;marshaller&quot;/&gt;
                &lt;property name=&quot;unmarshaller&quot; ref=&quot;marshaller&quot;/&gt;
        &lt;/bean&gt; 
        
        &lt;bean id=&quot;marshaller&quot; class=&quot;org.springframework.oxm.jaxb.Jaxb2Marshaller&quot;&gt;
                &lt;property name=&quot;contextPath&quot; value=&quot;net.javacrumbs.calc.model&quot;/&gt;
        &lt;/bean&gt;
&lt;/beans&gt;</pre></div><p>The only noteworthy part is the marshaller. JAXB2 is used and corresponding classes are generated by Maven using following <a class="externalLink" href="https://java-crumbs.svn.sourceforge.net/svnroot/java-crumbs/simple-client-test/tags/simple-client-test-0.22/simple-client-test/pom.xml">configuration</a>. </p><p>The client code is also simple, we just have to create request payload, send it to WS template and extract the response.</p><div><pre>public class Calc {
        @Autowired
        private WebServiceOperations wsTemplate;
        
        public int plus(int a, int b)
        {
                PlusRequest request = new PlusRequest();
                request.setA(a);
                request.setB(b);
                PlusResponse result = (PlusResponse) wsTemplate.marshalSendAndReceive(request);
                return result.getResult();
        }
}</pre></div></div><div class="section"><h3>The Test<a name="The_Test"></a></h3><p>Now when the code to be tested is clear, we can focus on the test itself. Let's start with the easiest one</p><div class="section"><h4>Response Generation<a name="Response_Generation"></a></h4><div><pre>@RunWith(SpringJUnit4ClassRunner.class)

//load your standard config
@ContextConfiguration(locations={&quot;classpath:client-config.xml&quot;})

//Add the listener (DirtiesContextTestExecutionListener.class,  TransactionalTestExecutionListener.class might be needed if @DirtiesContext or @Transactional is used.
@TestExecutionListeners({WsMockControlTestExecutionListener.class, DependencyInjectionTestExecutionListener.class})

public class CalcTest {
    @Autowired
    private Calc calc;
    
    //inject mock control
    @Autowired
    private WsMockControl mockControl;

        @Test
        public void testSimple()
        {
                mockControl.returnResponse(&quot;response1.xml&quot;);

                int result = calc.plus(1, 2);
                assertEquals(3, result);
                
                mockControl.verify();
        }
}</pre></div><p>The test class starts with <a class="externalLink" href="http://static.springsource.org/spring/docs/2.5.x/reference/testing.html#testcontext-ctx-management">standard Spring JUnit support</a>. The TestExecutionListener configuration section is the important bit. In addition to standard Spring listeners, WsMockControlTestExecutionListener.class is used. The listener does all the magic - it makes WsMockControl bean available, alters WsTemplate so no server is called and in general, it makes sure that everything works. Please note that DirtiesContextTestExecutionListener.class, TransactionalTestExecutionListener.class might be needed if @DirtiesContext or @Transactional is used.</p><p>Once we have WsMockControl, we can write the test. First of all, it's necessary to define which response should be returned from the web service call. That's achieved by <tt>mockControl.returnResponse(&quot;response1.xml&quot;);</tt> call. When we have this it's possible to call the WS client code. The mock infrastructure kicks in and instead of calling remote service, <tt>response1.xml</tt> is returned. </p><p>It's recommended to verify, that the web service was indeed called. It's done by <tt>mockControl.verify();</tt></p></div><div class="section"><h4>Request Validation<a name="Request_Validation"></a></h4><p>Usually it's useful to verify that the request generated by the client code has expected form. It's easy to achieve this way.</p><div><pre>@Test
public void testVerifyRequest()
{
        mockControl.expectRequest(&quot;request1.xml&quot;).returnResponse(&quot;response1.xml&quot;);
        
        int result = calc.plus(1, 2);
        assertEquals(3, result);
        
        mockControl.verify();
}</pre></div><p>Please note that it's possible to define the requests and responses either as <a class="externalLink" href="https://java-crumbs.svn.sourceforge.net/svnroot/java-crumbs/simple-client-test/tags/simple-client-test-0.22/simple-client-test/src/test/resources/response2.xml">full soap messages</a> or as <a class="externalLink" href="https://java-crumbs.svn.sourceforge.net/svnroot/java-crumbs/simple-client-test/tags/simple-client-test-0.22/simple-client-test/src/test/resources/response1.xml">payload only</a>. It depends only on your preference. </p></div><div class="section"><h4>Schema Validation<a name="Schema_Validation"></a></h4><p>We can also make sure the request conforms to XSD.</p><div><pre>@Test
public void testSchema()
{
        mockControl.validateSchema(&quot;xsd/calc.xsd&quot;).expectRequest(&quot;request1.xml&quot;).returnResponse(&quot;response1.xml&quot;);
        
        int result = calc.plus(1, 2);
        assertEquals(3, result);
        
        mockControl.verify();
}  </pre></div></div><div class="section"><h4>Ignoring Request Values<a name="Ignoring_Request_Values"></a></h4><p>Even though we could define special request and response file for every possible test it would soon become a maintenance nightmare. Therefore there are few mechanisms that allow us to reuse request and response files. The first one is the <tt>$<a name="IGNORE">IGNORE</a></tt> placeholder.</p><p>It's possible to ignore some parts of the request when comparing it to generated value.</p><div><pre>&lt;plusRequest xmlns=&quot;http://javacrumbs.net/calc&quot;&gt;
  &lt;a&gt;${IGNORE}&lt;/a&gt;
  &lt;b&gt;${IGNORE}&lt;/b&gt;
&lt;/plusRequest&gt;</pre></div><p>This &quot;template&quot; can be reused for all possible tests. Values of elements <tt>a</tt> and <tt>b</tt> are ignored.</p></div><div class="section"><h4>Response Templates<a name="Response_Templates"></a></h4><p>Similar mechanism can be used for responses too. In response, it's not possible just to simply ignore some values, we have to generate them. One way it is to use a XSLT template.</p><div><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;xsl:stylesheet xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; version=&quot;1.0&quot;&gt;
        &lt;xsl:template match=&quot;/&quot;&gt;
                        &lt;plusResponse xmlns=&quot;http://javacrumbs.net/calc&quot; xmlns:c=&quot;http://javacrumbs.net/calc&quot;&gt;
                          &lt;result&gt;&lt;xsl:value-of select=&quot;//c:a + //c:b&quot;/&gt;&lt;/result&gt;
                        &lt;/plusResponse&gt;
                &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;</pre></div><p>This template takes value from requests and calculates the response. Here we have in fact implemented the service using the template. In more real-life like scenarions it's useful too. It's possible to generate the response based on the request values. Even though XSLT is quite powerful toll, FreeMarker templates are supported too. You just have to call <tt>mockControl.useFreeMarkerTemplateProcessor()</tt>.</p></div><div class="section"><h4>Context Variables<a name="Context_Variables"></a></h4><p>Context Variables is another tool how to parametrize the templates. It's possible to define variables in the test script and use them in the template. Context Variables can be used both in request and response templates.</p><div><pre>        @Test
        public void testContext()
        {
                mockControl
                        .setTestContextAttribute(&quot;a&quot;, 1)
                        .setTestContextAttribute(&quot;b&quot;, 4)
                        .useFreeMarkerTemplateProcessor()
                        .expectRequest(&quot;request-context.xml&quot;)
                        .returnResponse(&quot;response2.xml&quot;);
                
                int result = calc.plus(1, 4);
                assertEquals(5, result);
                
                mockControl.verify();
        }</pre></div><p>FreeMarker template can look like this</p><div><pre>&lt;!-- Freemarker template --&gt;
&lt;plusRequest xmlns=&quot;http://javacrumbs.net/calc&quot;&gt;
  &lt;a&gt;${a}&lt;/a&gt;
  &lt;b&gt;${b}&lt;/b&gt;
&lt;/plusRequest&gt;</pre></div><p>It can be also used in XSLT this way</p><div><pre>&lt;xsl:stylesheet xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; version=&quot;1.0&quot;&gt;
        &lt;xsl:param name=&quot;a&quot;/&gt;
        &lt;xsl:param name=&quot;b&quot;/&gt;
        &lt;xsl:template match=&quot;/&quot;&gt;
                        &lt;plusRequest xmlns=&quot;http://javacrumbs.net/calc&quot;&gt;
                          &lt;a&gt;&lt;xsl:value-of select=&quot;$a&quot;/&gt;&lt;/a&gt;
                          &lt;b&gt;&lt;xsl:value-of select=&quot;$b&quot;/&gt;&lt;/b&gt;
                        &lt;/plusRequest&gt;
                &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;</pre></div></div><div class="section"><h4>Multiple Calls<a name="Multiple_Calls"></a></h4><p>It's also possible to test multiple calls of a WS in one test. The most straightforward approach is this</p><div><pre>@Test
public void testMultiple()
{
        mockControl.expectRequest(&quot;request-ignore.xml&quot;).atLeastOnce()
                .returnResponse(&quot;response2.xml&quot;)
                .returnResponse(&quot;response3.xml&quot;);
        
        assertEquals(5, calc.plus(2, 3));
        assertEquals(8, calc.plus(3, 5));
                        
        mockControl.verify();
}</pre></div><p>You can also define multiple expected requests, it's just necessary to define them in correct order</p><div><pre>@Test
public void testStrange()
{
        mockControl
            .expectRequest(&quot;request1.xml&quot;).returnResponse(&quot;response1.xml&quot;)
                .expectRequest(&quot;request-ignore.xml&quot;).returnResponse(&quot;response2.xml&quot;)
                .expectRequest(&quot;request1.xml&quot;).returnResponse(&quot;response1.xml&quot;);
        
        assertEquals(3, calc.plus(1, 2));
        assertEquals(5, calc.plus(2, 3));
        assertEquals(3, calc.plus(1, 2));
        
        mockControl.verify();
}</pre></div></div><div class="section"><h4>Internals<a name="Internals"></a></h4><p>Unit test support is based on <tt>RequestProcessor</tt>s as the rest of the framework. A <tt>RequestProcessor</tt> can either validate request, generate response, do nothing or throw an exception. By calling expectRequest, returnResponse, validateSchema and others a new RequestProcessor is created. All request processors used by WsMockControl are implementations of <tt>LimitingRequestProcessor</tt>. It means that besides their normal functionality they also keep track of number of calls they have processed. Moreover a <tt>LimitingRequestProcessor</tt> has minimum and maximum number of calls it can process. If less calls were processed an exception is thrown when WsMockControl.verify() was called. All calls over maximum limit are ignored. </p><p>By calling <tt>atLeastOnce()</tt>, <tt>times()</tt>, ... it is possible to set lower an upper limit on the RequestProcessor inserted last. Default value is one call.</p></div><div class="section"><h4>Functional tests<a name="Functional_tests"></a></h4><p>If you find yourself writing tests that result in lot of backend calls, consider using <a href="#func-test.html">Functional tests</a> instead. </p></div></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2013.
          All Rights Reserved.      
        
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
